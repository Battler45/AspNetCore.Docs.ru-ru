---
uid: signalr/overview/getting-started/tutorial-server-broadcast-with-signalr
title: Учебник. Передача сообщений с сервера с помощью SignalR 2 | Документация Майкрософт
author: tdykstra
description: Этом руководстве показано, как создать веб-приложения, использующего ASP.NET SignalR 2 для предоставления широковещательных функциональные возможности сервера. Вещание сервера означает, что commun...
ms.author: riande
ms.date: 10/13/2014
ms.assetid: 1568247f-60b5-4eca-96e0-e661fbb2b273
msc.legacyurl: /signalr/overview/getting-started/tutorial-server-broadcast-with-signalr
msc.type: authoredcontent
ms.openlocfilehash: ad2eee8742d5bc45dc2bdc90f76736b4dc94d14b
ms.sourcegitcommit: 74e3be25ea37b5fc8b4b433b0b872547b4b99186
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/12/2018
ms.locfileid: "53288023"
---
<a name="tutorial-server-broadcast-with-signalr-2"></a>Учебник. Передача сообщений с сервера с помощью SignalR 2
====================
по [том Дайкстра](https://github.com/tdykstra), [Tom FitzMacken](https://github.com/tfitzmac)

[!INCLUDE [Consider ASP.NET Core SignalR](~/includes/signalr/signalr-version-disambiguation.md)]

> Этом руководстве показано, как создать веб-приложения, использующего ASP.NET SignalR 2 для предоставления широковещательных функциональные возможности сервера. Рассылка сервера означает, что связям клиентам инициируются сервером. Данный сценарий требует другого подхода программирования, чем peer-to-peer сценариев, таких как приложения чата, в которых инициируется связям клиентам по одному или нескольким из клиентов.
>
> Приложение, которое вы создадите в этом руководстве имитирует биржевые сводки, типичный сценарий для широковещательных функциональные возможности сервера.
>
> В этом разделе был первоначально написан Майклом Патрик Флетчера.
>
> ## <a name="software-versions-used-in-the-tutorial"></a>Версии программного обеспечения, используемые в этом руководстве
>
>
> - [Visual Studio 2013](https://my.visualstudio.com/Downloads?q=visual%20studio%202013)
> - .NET 4.5
> - SignalR версии 2
>
>
>
> ## <a name="using-visual-studio-2012-with-this-tutorial"></a>С помощью Visual Studio 2012 с помощью этого руководства
>
>
> Чтобы использовать Visual Studio 2012 с этим руководством, сделайте следующее:
>
> - Обновление вашей [диспетчера пакетов](http://docs.nuget.org/docs/start-here/installing-nuget) до последней версии.
> - Установка [установщик веб-платформы](https://www.microsoft.com/web/downloads/platform.aspx).
> - В установщик веб-платформы, найдите и установите **ASP.NET и Web Tools 2013.1 для Visual Studio 2012**. Это будет установки Visual Studio шаблоны для SignalR классов, таких как **центр**.
> - Некоторые шаблоны (такие как **класс запуска OWIN**) будут недоступны; для этого используйте файл класса.
>
>
> ## <a name="tutorial-versions"></a>Учебника по версии
>
> Сведения о более ранних версий SignalR, см. в разделе [более старых версий SignalR](../older-versions/index.md).
>
> ## <a name="questions-and-comments"></a>Вопросы и комментарии
>
> Оставьте свои отзывы на том, как вам понравилось, и этот учебник и что можно улучшить в комментариях в нижней части страницы. Если у вас есть вопросы, которые не имеют отношения к руководству, их можно разместить [форум по ASP.NET SignalR](https://forums.asp.net/1254.aspx/1?ASP+NET+SignalR) или [StackOverflow.com](http://stackoverflow.com/).

## <a name="overview"></a>Обзор

В этом руководстве будет создание приложения биржевые сводки, представляющих приложений в реальном времени, в которых требуется периодически «push», или рассылка, уведомлений с сервера все подключенные клиенты. В первой части этого учебника вы создадите упрощенную версию этого приложения с нуля. В оставшейся части руководства вы установите пакет NuGet, который содержит дополнительные функции и просмотрите код для этих функций.

Приложение, которое вы создадите в первой части этого учебника представлена таблица со биржевых данных.

![Начальная версия StockTicker](tutorial-server-broadcast-with-signalr/_static/image1.png)

Периодически сервер случайным образом обновляет акций и отправляет обновления всех подключенных клиентов. В браузере чисел и символов в **изменить** и **%** динамически изменять столбцы в ответ на уведомления от сервера. Если открыть дополнительные браузеров на том же URL-адрес, все они Показывать те же данные и те же изменения в данные одновременно.

Этот учебник содержит следующие разделы:

- [Необходимые компоненты](#prerequisites)
- [Создание проекта](#createproject)
- [Настройте серверный код](#server)
- [Настройка кода клиента](#client)
- [Тестирование приложения](#test)
- [Включение ведения журнала](#enablelogging)
- [Установка и просмотрите полный пример StockTicker](#fullsample)
- [Следующие шаги](#nextsteps)

[Microsoft.AspNet.SignalR.Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) пакет NuGet устанавливает пример simulated биржевые сводки приложения в проекте Visual Studio.

> [!NOTE]
> Если вы не хотите работать шаги по созданию приложения, можно установить пакет SignalR.Sample в новом проекте пустое веб-приложение ASP.NET. Если вы установите пакет NuGet без выполнения действия в этом руководстве **необходимо выполнить инструкции в файле readme.txt**. Чтобы запустить пакет, необходимо добавить класс запуска OWIN, который вызывает метод ConfigureSignalR в установленном пакете. Вы получите ошибку, если вы не добавили класс запуска OWIN.


<a id="prerequisites"></a>

## <a name="prerequisites"></a>Предварительные требования

Перед началом работы убедитесь, что у вас есть Visual Studio 2013, установленной на компьютере. Если у вас нет Visual Studio, см. в разделе [загрузок ASP.NET](https://www.asp.net/downloads) для получения бесплатной Visual Studio 2013 Express.

<a id="createproject"></a>

## <a name="create-the-project"></a>Создание проекта

1. Из **файл** меню, щелкните **новый проект**.
2. В **новый проект** диалогового окна разверните узел **C#** под **шаблоны** и выберите **Web**.
3. Выберите **пустое веб-приложение ASP.NET** шаблон, имя проекта *SignalR.StockTicker*и нажмите кнопку **ОК**.

    ![Диалоговое окно “Новый проект”](tutorial-server-broadcast-with-signalr/_static/image2.png)
4. В **нового ASP.NET** окно проекта, оставьте **пустой** и нажмите кнопку **Создание проекта**.

    ![Диалоговое окно нового проекта ASP](tutorial-server-broadcast-with-signalr/_static/image3.png)

<a id="server"></a>

## <a name="set-up-the-server-code"></a>Настройте серверный код

В этом разделе можно настроить код, который выполняется на сервере.

### <a name="create-the-stock-class"></a>Создайте класс акции

Сначала создается класс модели Stock, которое будет использоваться для хранения и передачи информации о акций.

1. Создайте новый файл класса в папке проекта, назовите его *Stock.cs*, а затем замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample1.cs)]

    Два свойства, которые вы укажете при создании акции: символ (например, MSFT корпорации Майкрософт) и цену. Другие свойства зависят от того, как и когда можно установить цену. В первый раз установить цену, значение возвращает распространяются DayOpen. В следующий раз, если задается цену, изменения и значения свойств PercentChange вычисляются на основе разницы между ценой и DayOpen.

### <a name="create-the-stockticker-and-stocktickerhub-classes"></a>Создание классов StockTicker и StockTickerHub

Вы используете API концентратора SignalR для обработки взаимодействия клиентом и сервером. StockTickerHub класс, производный от класса концентратора SignalR обрабатывающий получение подключений и вызовы методов из клиентов. Необходимо также поддерживать биржевых данных и выполнения объекта таймера периодически запускать обновления цены, независимо от клиентских подключений. Эти функции нельзя поместить в класс концентратора, так как экземпляры концентратора являются временными. Экземпляр класса центра создается для каждой операции в концентраторе, такие как подключения и вызовы от клиента к серверу. Поэтому для запуска в отдельном классе, который следует именовать StockTicker имеет механизм, который отслеживает биржевых данных, затем обновляет цены и передает изменения цены.

![Широковещательная рассылка из StockTicker](tutorial-server-broadcast-with-signalr/_static/image5.png)

Требуется только один экземпляр класса StockTicker для запуска на сервере, поэтому вам потребуется настроить ссылку из каждого экземпляра StockTickerHub StockTicker одноэлементный экземпляр. Класс StockTicker должен быть способен рассылать клиентам, так как он имеет биржевых данных и триггеров обновлений, но StockTicker не является классом концентратора. Таким образом класс StockTicker должен получить ссылку на объект контекста подключения концентратора SignalR. Он этого можно использовать объект контекста подключения SignalR для рассылки клиентам.

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект и нажмите кнопку **Add | Класс концентратора SignalR (v2)**.
2. Назовите новый концентратор *StockTickerHub.cs*, а затем нажмите кнопку **добавить**. Пакеты SignalR NuGet будет добавлен в проект.
3. Замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample2.cs)]

    [Концентратора](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hub(v=vs.111).aspx) класс используется для определения методов, клиенты могут вызывать на сервере. Вы определяете один метод: `GetAllStocks()`. Когда клиент сначала производит подключение к серверу, он вызывает этот метод, чтобы получить список всех акций с их текущие цены. Метод может выполняться синхронно и возвращать `IEnumerable<Stock>` так, как он возвращает данные из памяти. Если метод должен получить данные, выполнив то, что будет включать в себя оповещения, такие как поиск в базе данных или вызов веб-службы, следует указать `Task<IEnumerable<Stock>>` как возвращаемое значение асинхронной обработки. Дополнительные сведения см. в разделе [ASP.NET руководство по API концентраторов SignalR - Server - когда следует выполнить асинхронно](../guide-to-the-api/hubs-api-guide-server.md#asyncmethods).

    HubName атрибут указывает, как концентратор будет ссылаться в коде JavaScript на стороне клиента. Имя по умолчанию на стороне клиента, если вы не используете этот атрибут — это версия стиле Camel, от имени класса, который в данном случае было бы stockTickerHub.

    Как вы увидите позже при создании класса StockTicker, одноэлементный экземпляр этого класса создается в его статическое свойство экземпляра. Одноэлементный экземпляр StockTicker остается в памяти независимо от того, сколько клиентов подключить или отключить, что этот экземпляр используется метод GetAllStocks для возврата текущего биржевых данных.
4. Создайте новый файл класса в папке проекта, назовите его *StockTicker.cs*, а затем замените код шаблона следующим кодом:

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample3.cs)]

    Так как несколько потоков будут выполняться один и тот же экземпляр кода StockTicker, StockTicker класс должен быть threadsafe.

    ### <a name="storing-the-singleton-instance-in-a-static-field"></a>Хранение одноэлементного экземпляра в статическом поле

    Этот код инициализирует статические \_экземпляр поля, поддерживающего свойство экземпляра с экземпляром класса, и это является единственным экземпляром класса, которые могут быть созданы, так как конструктор помечен как частный. [Отложенная инициализация](https://msdn.microsoft.com/library/dd997286.aspx) используется для \_поле экземпляра, а не для повышения производительности, но чтобы обеспечить создание экземпляра threadsafe.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample4.cs)]

    Каждый раз, когда клиент подключается к серверу, новый экземпляр класса StockTickerHub, работающих в отдельном потоке Получает одноэлементный экземпляр StockTicker из статического свойства StockTicker.Instance, как было показано ранее в классе StockTickerHub.

    ### <a name="storing-stock-data-in-a-concurrentdictionary"></a>Хранение данных акций в руководство.

    Конструктор инициализирует \_коллекция акций с некоторыми биржевых данных образец и GetAllStocks возвращает акций. Как было показано ранее, эта коллекция акции в свою очередь возвращается StockTickerHub.GetAllStocks, этот метод в классе концентратора, который клиенты могут вызывать сервера.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample5.cs)]

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample6.cs)]

    Представляет собой коллекцию акции [ConcurrentDictionary](https://msdn.microsoft.com/library/dd287191.aspx) тип потокобезопасности. В качестве альтернативы можно использовать [словарь](https://msdn.microsoft.com/library/xfhwa508.aspx) объекта и явным образом блокировка словаря, при внесении изменений в него.

    Для этого примера приложения что достаточно для хранения данных приложений в памяти и потери данных при удалении экземпляра StockTicker. В реальном приложении будет работать с хранилищем данных серверной части, например в базе данных.

    ### <a name="periodically-updating-stock-prices"></a>Периодическое обновление акций

    Конструктор запуске объект таймера, который периодически вызывает методы, которые обновляют акций на основе случайной выборки.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample7.cs)]

    UpdateStockPrices вызывается таймер, который передает значения NULL в параметре state. Перед обновлением цены, блокировки \_updateStockPricesLock объекта. Код проверяет, если другой поток уже обновляется цены, а затем он вызывает TryUpdateStockPrice на каждой из них в списке. Метод TryUpdateStockPrice решает, следует ли изменить цену акций и какой объем, чтобы изменить его. Если изменяется акций, BroadcastStockPrice называется рассылать изменения цены акций для всех подключенных клиентов.

    \_UpdatingStockPrices флаг помечается как [volatile](https://msdn.microsoft.com/library/x13ttww7.aspx) для обеспечения доступа к нему threadsafe.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample8.cs)]

    В реальном приложении метод TryUpdateStockPrice вызовет веб-службы для поиска цены. в этом коде в нем генератор случайных чисел для внесения изменений случайным образом.

    ### <a name="getting-the-signalr-context-so-that-the-stockticker-class-can-broadcast-to-clients"></a>Получение контекста SignalR, таким образом, чтобы класс StockTicker могут производить широковещательную рассылку для клиентов

    Поскольку изменения цен здесь приходят в объекте StockTicker, это объект, которому требуется вызывать метод updateStockPrice на всех подключенных клиентов. В классе центр имеется API, вызов клиентских методов, но StockTicker, не является производным от класса концентратора и не содержит ссылку на объект любого концентратора. Таким образом для передачи подключенным клиентам, класс StockTicker должен получение экземпляра контекста SignalR для класса StockTickerHub и использовать его для вызова методов на клиентах.

    Код получает ссылку на контекст SignalR, когда он создает одноэлементный экземпляр класса, которые ссылаются на передается конструктору, и конструктор помещает его в свойстве клиентов.

    Есть две причины, почему вы хотите получить контекст только один раз: получение контекста является ресурсоемкой операцией и получения его один раз обеспечивает сохранение последовательности сообщений, отправляемых клиентам.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample9.cs)]

    Получение свойства контекста клиентов и поместить его в свойстве StockTickerClient позволяет написать код для вызова методов клиента, который выглядит так же, как если бы в классе концентратора. Например чтобы вещать на все клиенты можно написать Clients.All.updateStockPrice(stock).

    Метод updateStockPrice, который вы вызываете в BroadcastStockPrice не существует; она будет добавлена позже при написании кода, который выполняется на стороне клиента. Могут ссылаться на updateStockPrice здесь, так как Clients.All является динамической, это означает, что выражение будет вычисляться во время выполнения. При выполнении этого вызова метода, SignalR на клиент отправит имя метода и значение параметра и если клиент имеет метод с именем updateStockPrice, этот метод будет вызван, и к нему будет передаваться значение параметра.

    Clients.All означает отправки всем клиентам. SignalR предоставляет другие параметры, чтобы указать, какие клиенты или группы клиентов для отправки. Дополнительные сведения см. в разделе [HubConnectionContext](https://msdn.microsoft.com/library/microsoft.aspnet.signalr.hubs.hubconnectioncontext(v=vs.111).aspx).

### <a name="register-the-signalr-route"></a>Регистрация маршрутов SignalR

Сервер должен знать, какой URL-адрес для перехвата и направить SignalR. Чтобы сделать это, добавьте класс запуска OWIN:

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект и нажмите кнопку **Add | Класс запуска OWIN**. Назовите класс **Startup.cs**.
2. Замените код в **Startup.cs** приведенным ниже.

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample10.cs)]

Вы завершили настройку серверный код. В следующем разделе будет настройки клиента.

<a id="client"></a>

## <a name="set-up-the-client-code"></a>Настройка кода клиента

1. Создайте новый HTML-файл в папке проекта и назовите его *StockTicker.html*.
2. Замените код шаблона следующим кодом.

    [!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample11.html)]

    HTML-код создается таблица с 5 столбцами, строку заголовка и строку данных с одной ячейкой, охватывающий все 5 столбцов. Строка данных отображает «загрузка...» и будет отображаться только мгновенно при запуске приложения. Код JavaScript будет удалить эту строку и добавьте в строках месте биржевых данных, получаемых с сервера.

    Теги сценария укажите в файле скрипта jQuery, файла скрипта SignalR core, файле SignalR прокси сценария и файл сценария StockTicker, будет создано позже. Файл скрипта SignalR прокси, который указывает URL-адрес «/ signalr/концентраторы», создается динамически и определяет в этом случае для StockTickerHub.GetAllStocks методы прокси-сервера для методов применительно к классу Hub. При желании можно создать этот файл JavaScript вручную с помощью [служебные программы SignalR](http://nuget.org/packages/Microsoft.AspNet.SignalR.Utils/) и отключить создание динамического файла в вызове метода MapHubs.
3. > [!IMPORTANT]
   > Убедитесь, что ссылается на файл JavaScript в *StockTicker.html* указаны правильно. Т. е убедитесь, что версия jQuery в тег сценария (1.10.2 в примере) совпадает со значением версии jQuery в вашем проекте *сценариев* папки и убедитесь, что версия SignalR в тег сценария совпадает со значением SignalR версии в вашем проекте *сценариев* папки. При необходимости измените имена файлов в теги сценариев.
4. В **обозревателе решений**, щелкните правой кнопкой мыши *StockTicker.html*, а затем нажмите кнопку **задать в качестве начальной страницы**.
5. Создайте новый файл JavaScript в папке проекта и назовите его *StockTicker.js*...
6. Замените код шаблона следующим кодом:

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample12.js)]

    $.connection ссылается на прокси-серверы SignalR. Код получает ссылку на прокси-сервер для класса StockTickerHub и помещает его в переменной биржевых котировок. Имя прокси-сервер имеет имя, которое было задано с помощью атрибута [HubName]:

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample13.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample14.cs)]

    Определив все переменные и функции, в последней строке кода в файле инициализирует подключения SignalR путем вызова функции запуска SignalR. Функция запуска выполняется асинхронно и возвращает [объект jQuery отложенный](http://api.jquery.com/category/deferred-object/), который означает, что можно вызвать функцию Готово для указания функция, вызываемая при завершении асинхронной операции...

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample15.js)]

    Функция init вызывает функцию getAllStocks на сервере и использует сведения, сервер возвращает для обновления таблицы акций. Обратите внимание на то, что по умолчанию, необходимо использовать смешанный регистр на клиентском компьютере, несмотря на то, что имя метода в стиле Pascal на сервере. Регистрах правило применяется только к методам, не объекты. Например можно ссылаться на склад. Символ и акции. Цена, не stock.symbol или stock.price.

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample16.js)]

    [!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample17.cs)]

    Если вы хотите использовать регистра pascal на клиенте, или если вы хотите использовать имя совершенно другой метод, удалось снабдить метода концентратора с атрибутом HubMethodName так же, как вы декорировать классу Hub с атрибутом HubName.

    В методе init HTML-код для строки таблицы создается для каждого объекта акций, полученных с сервера вызывающего formatStock для свойства форматирования stock-объектом, а путем вызова вытесняют (который определен в верхней части *StockTicker.js*) для замещения местозаполнителей в переменной rowTemplate со значениями свойств stock-объектом. Затем полученный HTML добавляется к таблице акций.

    Вызвать init, передавая его в качестве функции обратного вызова, который выполняется после завершения функции асинхронного запуска. Если init вызывается как отдельную инструкцию после начала вызова JavaScript, функция завершится сбоем, так как оно будет выполнено немедленно, не дожидаясь функции запуска для завершения подключения к. В этом случае функция init будет выполнена попытка вызвать функцию getAllStocks, прежде чем будет установлено соединение с сервером.

    Когда сервер изменяет цены акции, она вызывает updateStockPrice на подключенных клиентов. Функция будет добавлена свойству клиента на прокси-сервере stockTicker, чтобы сделать его доступным для вызовов с сервера.

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample18.js)]

    Функция updateStockPrice форматирует получил от сервера в строке таблицы так же, как и в функции init stock-объектом. Тем не менее вместо того чтобы добавить строку в таблицу, он находит акции текущей строки в таблице и заменяет эту строку на новую.

<a id="test"></a>

## <a name="test-the-application"></a>Тестирование приложения

1. Нажмите клавишу F5, чтобы запустить приложение в режиме отладки.

    Таблицы акций изначально отображает «идет загрузка...» строки, затем после небольшой задержки появится начальная биржевых данных, и запустите акций для изменения.

    ![Загрузка](tutorial-server-broadcast-with-signalr/_static/image6.png)

    ![Начальная таблица акций](tutorial-server-broadcast-with-signalr/_static/image7.png)

    ![Биржевые таблица, получающая изменения с сервера](tutorial-server-broadcast-with-signalr/_static/image8.png)
2. Скопируйте URL-адрес в адресной строке браузера и вставьте его в один или несколько новых окна браузера.

    Исходное отображение биржевых совпадает с первым браузером, и изменения происходят одновременно.
3. Закройте все браузеры и открыть обозреватель, а затем перейдите на том же URL-адрес.

    Для запуска на сервере, поэтому в примере показано отображение биржевых таблицы акций продолжил изменять продолжает StockTicker одноэлементного объекта. (Вы не видите первоначальной таблицы с нуля изменить данные).
4. Закройте браузер.

<a id="enablelogging"></a>

## <a name="enable-logging"></a>Включение ведения журнала

SignalR имеет встроенные функции, которую можно включить на стороне клиента для устранения неисправностей. В этом разделе описано включение ведения журнала и примеры, показывающие, как журналы скажет, какой из следующих методов транспорта использует SignalR см. в разделе:

- [WebSockets](http://en.wikipedia.org/wiki/WebSocket), поддерживается IIS 8 и современных обозревателей.
- [Сервер отправил события](http://en.wikipedia.org/wiki/Server-sent_events), поддерживаемых браузеров, отличных от Internet Explorer.
- [Forever frame](http://en.wikipedia.org/wiki/Comet_(programming)#Hidden_iframe), поддерживаемых обозревателем Internet Explorer.
- [AJAX, длинный опрос](http://en.wikipedia.org/wiki/Comet_(programming)#Ajax_with_long_polling), поддерживаемый всеми браузерами.

Для любого соединения SignalR выбирает лучший метод транспорта, сервер и клиент поддерживают.

1. Откройте *StockTicker.js* и добавьте строку кода, чтобы включить ведение журнала непосредственно перед код, который инициализирует подключение в конце файла:

    [!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample19.js)]
2. Нажмите клавишу F5, чтобы запустить проект.
3. Откройте окно инструментов разработчика в браузере и выберите консоль, чтобы просмотреть журналы. Может потребоваться обновить страницу, чтобы просмотреть журналы Signalr согласования метода транспорта для нового соединения.

    Если вы используете Internet Explorer 10 в Windows 8 (IIS 8), метод транспорта является WebSockets.

    ![Консоли IE 10 IIS 8](tutorial-server-broadcast-with-signalr/_static/image9.png)

    Если вы используете Internet Explorer 10 в Windows 7 (IIS 7.5), метод транспорта является iframe.

    ![IE 10 консоли IIS 7.5](tutorial-server-broadcast-with-signalr/_static/image10.png)

    В обозревателе Firefox установите надстройка Firebug, чтобы получать окно консоли. Если вы используете Firefox 19 в Windows 8 (IIS 8), метод транспорта является WebSockets.

    ![Firefox 19 IIS 8 Websockets](tutorial-server-broadcast-with-signalr/_static/image11.png)

    Если вы используете Firefox 19 в Windows 7 (IIS 7.5), метод транспорта — события отправки сервером.

    ![Firefox 19 консоли IIS 7.5](tutorial-server-broadcast-with-signalr/_static/image12.png)

<a id="fullsample"></a>

## <a name="install-and-review-the-full-stockticker-sample"></a>Установка и просмотрите полный пример StockTicker

Приложение StockTicker, которая устанавливается вместе с [Microsoft.AspNet.SignalR.Sample](http://nuget.org/packages/microsoft.aspnet.signalr.sample) пакет NuGet включает больше возможностей, чем упрощенная версия, только что созданную с нуля. В этом разделе руководства вы установите пакет NuGet и просмотрите новые функции и код, который реализует их. Если установить пакет без выполнения на предыдущих шагах этого учебника, необходимо добавить класс запуска OWIN в проект. Этот шаг описан в файле readme.txt для пакета NuGet.

### <a name="install-the-signalrsample-nuget-package"></a>Установите пакет SignalR.Sample NuGet

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект и нажмите кнопку **управление пакетами NuGet**.
2. В **управление пакетами NuGet** диалоговом окне щелкните **Online**, введите *SignalR.Sample* в **поиск в Интернете** , а затем щелкните  **Установка** в **SignalR.Sample** пакета.

    ![Установите пакет SignalR.Sample](tutorial-server-broadcast-with-signalr/_static/image13.png)
3. В **обозревателе решений**, разверните *SignalR.Sample* папку, которая была создана путем установки пакета SignalR.Sample.
4. В *SignalR.Sample* папку, щелкните правой кнопкой мыши *StockTicker.html*, а затем нажмите кнопку **задать в качестве начальной страницы**.

    > [!NOTE]
    > Установка SignalR.Sample NuGet пакета может изменить версию jQuery, у вас есть в вашей *сценариев* папки. Новый *StockTicker.html* файл пакета установки в *SignalR.Sample* папки будут синхронизированы с версии jQuery, которая устанавливает пакет, но если вы хотите запустить исходную *StockTicker.html* файл еще раз, необходимо сначала обновить ссылку на jQuery в тег сценария.

### <a name="run-the-application"></a>Запуск приложения

1. Нажмите клавишу F5 для запуска приложения.

    В дополнение к таблице, которая вы уже видели полной биржевые сводки приложения отображается окно с горизонтальной прокруткой отображает те же данные акций. При запуске приложения в первый раз, «Марка» «закрыто», и вы увидите статическую таблицу и окно биржевых котировок, которое не прокрутки.

    ![Экран запуска StockTicker](tutorial-server-broadcast-with-signalr/_static/image14.png)

    При нажатии кнопки **Open Market**, **Live биржевых котировок акций** поле начинает прокручиваться по горизонтали, и сервер запускается периодически рассылать изменения цены акций на основе случайной выборки. Каждый раз, когда цены акций изменяется, оба **Live Stock таблицы** сетки и **Live биржевых котировок акций** обновляются поля. При изменении цены акции является положительным, акции отображается с зеленым фоном, и когда будет отрицательным, акции отображается с красным фоном.

    ![Откройте приложение StockTicker рынка](tutorial-server-broadcast-with-signalr/_static/image15.png)

    **Закрыть рынка** кнопка останавливает изменения и останавливает прокрутка биржевых котировок и **Сброс** сбрасывает все биржевых данных в исходное состояние до начала изменения цен. Если вы открываете дополнительные окна браузера и перейдите к тем же URL-адрес, вы увидите те же данные, динамически обновляются в то же время, в каждом браузере. Если щелкнуть одну из кнопок, все браузеры одинаково реагировать на в то же время.

### <a name="live-stock-ticker-display"></a>Динамическое отображение биржевых котировок акций

**Live биржевых котировок акций** отображается неупорядоченный список в элемент div, отформатированный в одну строку от стилей CSS. Инициализируется биржевых котировок и обновить так же, как таблицы:, заменив заполнители в &lt;li&gt; строка шаблона и динамическое добавление &lt;li&gt; элементы &lt;ul&gt; элемент. Прокрутка выполняется с помощью анимировать функция jQuery для изменения margin-left неупорядоченного списка в пределах div.

Биржевые сводки HTML:

[!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample20.html)]

Биржевые сводки CSS:

[!code-html[Main](tutorial-server-broadcast-with-signalr/samples/sample21.html)]

Прокрутите кода jQuery, что позволяет:

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample22.js)]

### <a name="additional-methods-on-the-server-that-the-client-can-call"></a>Дополнительные методы на сервере, который клиент может вызывать

Класс StockTickerHub определяет четыре дополнительные методы, которые клиент может вызывать:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample23.cs)]

OpenMarket CloseMarket и сброса вызываются в ответ на кнопки в верхней части страницы. Они показывают шаблон из одного клиента, активируя изменение в состоянии, немедленно распространяются на все клиенты. Каждый из этих методов вызывает метод в классе StockTicker которые влияют на состояние рынка, изменить и затем осуществляет широковещательную передачу новое состояние.

В классе StockTicker состояние рынка поддерживается с помощью свойства MarketState, которое возвращает значение перечисления MarketState:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample24.cs)]

Каждый из методов, изменяющих состояние рынка делать это внутри блок lock, так как класс StockTicker должен быть threadsafe:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample25.cs)]

Чтобы убедиться, что этот код является threadsafe, \_marketState поля, поддерживающего свойство MarketState помечается как volatile,

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample26.cs)]

Методы BroadcastMarketStateChange и BroadcastMarketReset аналогичны BroadcastStockPrice метод, который вы уже видели, за исключением того, они вызывают различные методы, определенные на стороне клиента:

[!code-csharp[Main](tutorial-server-broadcast-with-signalr/samples/sample27.cs)]

### <a name="additional-functions-on-the-client-that-the-server-can-call"></a>Дополнительные функции на клиенте, который сервер может обратиться

Функция updateStockPrice теперь обрабатывает сетки и отображение биржевых котировок и использует jQuery.Color начинает мигать, красного и зеленого цвета.

Новые функции в *SignalR.StockTicker.js* Включение и отключение кнопок на основе рынок состояния и остановить или запустить биржевых котировок окно горизонтальную прокрутку. Так как несколько функций, добавленных ticker.client, [jQuery расширить функции](http://api.jquery.com/jQuery.extend/) используется для добавления их.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample28.js)]

### <a name="additional-client-setup-after-establishing-the-connection"></a>Программа установки дополнительного клиента после подключения к

После того как клиент устанавливает соединение, он имеет некоторые проделать дополнительную работу: проверить, является ли рынке открытым или закрытым, чтобы вызовите соответствующий marketOpened или функция marketClosed и вложить вызовы методов сервера кнопок.

[!code-javascript[Main](tutorial-server-broadcast-with-signalr/samples/sample29.js)]

Методы сервера не соединены до кнопки до после того как соединение установлено, таким образом, чтобы код не может попытаться вызвать методы сервера, прежде чем они станут доступны.

<a id="nextsteps"></a>

## <a name="next-steps"></a>Следующие шаги

В этом руководстве вы узнали, как запрограммировать приложение SignalR, которое передает сообщения с сервера все подключенные клиенты, как на периодической основе, так и в ответ на уведомления из любого клиента. Шаблон использования несколькими потоками одноэлементный экземпляр для отслеживания состояния сервера может также использоваться в многопользовательских online game сценариях. Например, см. в разделе [ShootR игры, основанный на SignalR](https://github.com/NTaylorMullen/ShootR).

Учебники, которые показывают связи peer-to-peer сценариев, см. в разделе [начало работы с SignalR](introduction-to-signalr.md) и [обновления в реальном времени с SignalR](tutorial-high-frequency-realtime-with-signalr.md).

Более сложные концепции разработки SignalR см. на следующих узлах SignalR исходный код и ресурсы:

- [ASP.NET SignalR](../../index.md)
- [Проект SignalR](http://signalr.net/)
- [SignalR Github и примерами](https://github.com/SignalR/SignalR)
- [Вики-сайте SignalR](https://github.com/SignalR/SignalR/wiki)

Пошаговое руководство о том, как развернуть приложение SignalR в Azure, см. в разделе [с помощью SignalR с веб-приложениями в службе приложений Azure](../deployment/using-signalr-with-azure-web-sites.md). Подробные сведения о развертывании веб-проекта Visual Studio для веб-сайта Windows Azure см. в разделе [создать веб-приложение ASP.NET в службе приложений Azure](https://azure.microsoft.com/documentation/articles/web-sites-dotnet-get-started/).
