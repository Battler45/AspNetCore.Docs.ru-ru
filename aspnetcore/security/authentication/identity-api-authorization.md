---
title: Общие сведения об аутентификации для одностраничных приложений на ASP.NET Core
author: javiercn
description: Использование идентификаторов с одностраничное приложение, в рамках приложения ASP.NET Core.
monikerRange: '>= aspnetcore-3.0'
ms.author: scaddie
ms.custom: mvc
ms.date: 03/07/2019
uid: security/authentication/identity/spa
ms.openlocfilehash: 302a5e10a70e40e75ab9fe4b3e5a98c4e847b822
ms.sourcegitcommit: 8516b586541e6ba402e57228e356639b85dfb2b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67815223"
---
# <a name="authentication-and-authorization-for-spas"></a>Проверка подлинности и авторизация для одностраничных приложений

ASP.NET Core 3.0 или более поздней предлагает проверки подлинности в одностраничных приложений (SPA), используя поддержку API авторизации. Удостоверение ASP.NET Core для проверки подлинности и хранение данных пользователей в сочетании с [IdentityServer](https://identityserver.io/) для реализации Open ID Connect.

Был добавлен параметр проверки подлинности **Angular** и **React** , аналогично параметру проверки подлинности в шаблоны проектов **веб-приложение (Model-View-Controller)**  (MVC) и **веб-приложение** шаблоны проектов (Razor Pages). Допустимых значениях параметров являются **None** и **отдельных**. **React.js и Redux** шаблон проекта не поддерживает параметр проверки подлинности в данный момент.

## <a name="create-an-app-with-api-authorization-support"></a>Создать приложение с помощью поддержки проверки подлинности API

Проверки подлинности пользователя можно с помощью Angular и React одностраничные приложения. Откройте командную строку и выполните следующую команду:

**Angular**:

```console
dotnet new angular -o <output_directory_name> -au Individual
```

**REACT**:

```console
dotnet new react -o <output_directory_name> -au Individual
```

Приведенная выше команда создает приложения ASP.NET Core с помощью *ClientApp* каталог, содержащий SPA.

## <a name="general-description-of-the-aspnet-core-components-of-the-app"></a>Общее описание компонентов приложения ASP.NET Core

В следующих разделах описаны дополнения к проекту, когда включается поддержка проверки подлинности:

### <a name="startup-class"></a>Класс Startup

`Startup` Класс имеет следующими дополнениями:

* Внутри `Startup.ConfigureServices` метод:
  * Удостоверение с помощью пользовательского интерфейса по умолчанию:

    ```csharp
    services.AddDbContext<ApplicationDbContext>(options =>
        options.UseSqlite(Configuration.GetConnectionString("DefaultConnection")));

    services.AddDefaultIdentity<ApplicationUser>()
        .AddDefaultUI(UIFramework.Bootstrap4)
        .AddEntityFrameworkStores<ApplicationDbContext>();
    ```

  * Сервер с помощью дополнительного `AddApiAuthorization` вспомогательный метод этой настройки некоторые по умолчанию соглашения об ASP.NET Core поверх IdentityServer:

    ```csharp
    services.AddIdentityServer()
        .AddApiAuthorization<ApplicationUser, ApplicationDbContext>();
    ```

  * Проверка подлинности с помощью дополнительного `AddIdentityServerJwt` вспомогательный метод, который настраивает приложение для проверки маркеров JWT, полученных при IdentityServer:

    ```csharp
    services.AddAuthentication()
        .AddIdentityServerJwt();
    ```

* Внутри `Startup.Configure` метод:
  * Промежуточного по проверки подлинности, который отвечает за проверку учетных данных запроса и настройке пользователя на контекст запроса:

    ```csharp
    app.UseAuthentication();
    ```

  * IdentityServer промежуточного слоя, которое предоставляет конечные точки Open ID Connect:

    ```csharp
    app.UseIdentityServer();
    ```

### <a name="addapiauthorization"></a>AddApiAuthorization

Этот вспомогательный метод настраивает сервер для использования нашей поддерживаемые конфигурации. IdentityServer — это мощная и расширяемая платформа для обработки обеспечения безопасности приложения. В то же время, предоставляющий ненужные сложности для наиболее распространенных сценариев. Следовательно набор соглашений и параметры конфигурации вам предоставляется, которые считаются хорошей отправной точкой. После изменения потребностей проверки подлинности, всю мощь identityserver должно по-прежнему доступен для настройки проверки подлинности в соответствии с потребностями.

### <a name="addidentityserverjwt"></a>AddIdentityServerJwt

Этот вспомогательный метод настраивает схему политики для приложения в качестве обработчика проверки подлинности по умолчанию. Эта политика настроена для удостоверения, которые обрабатывают все запросы направляются все вложенный путь в пространстве URL-адрес удостоверения «/ Identity». `JwtBearerHandler` Обрабатывает все запросы. Кроме того, этот метод регистрирует `<<ApplicationName>>API` API ресурсов с identityserver должно с областью по умолчанию `<<ApplicationName>>API` и настраивает промежуточного слоя маркеров носителей JWT для проверки токенов, выданных IdentityServer для приложения.

### <a name="sampledatacontroller"></a>SampleDataController

В *Controllers\SampleDataController.cs* файл, обратите внимание, что `[Authorize]` атрибут, примененный к классу, который указывает, что пользователь должен быть авторизован исходя из политики по умолчанию для доступа к ресурсу. Политика авторизации по умолчанию происходит с настроить для использования схему проверки подлинности по умолчанию, который настраивается с `AddIdentityServerJwt` схему политики, которая упоминалась выше, делая `JwtBearerHandler` задаются обработчик по умолчанию для таких вспомогательный метод запросы к приложению.

### <a name="applicationdbcontext"></a>ApplicationDbContext

В *Data\ApplicationDbContext.cs* файл, обратите внимание, что же `DbContext` используется удостоверение с исключением, который он расширяет `ApiAuthorizationDbContext` (более производный класс от `IdentityDbContext`) для включения схемы для IdentityServer.

Чтобы получить полный контроль схемы базы данных, унаследованные от одного из доступных удостоверений `DbContext` классов и настроить контекст включать схему удостоверений, вызвав `builder.ConfigurePersistedGrantContext(_operationalStoreOptions.Value)` на `OnModelCreating` метод.

### <a name="oidcconfigurationcontroller"></a>OidcConfigurationController

В *Controllers\OidcConfigurationController.cs* файл, обратите внимание, что конечную точку, которая подготавливается для обслуживания OIDC параметры, необходимые клиенту для использования.

### <a name="appsettingsjson"></a>appsettings.json

В *appsettings.json* файл из корневого каталога проекта, доступна новая `IdentityServer` раздел, описывающий список настроить клиенты. В следующем примере имеется один клиент. Имя клиента соответствует имени приложения и сопоставить по соглашению с OAuth `ClientId` параметра. Профиль указывает настраиваемый тип приложения. Он используется системой для обозначения дисков, которые упрощают процесс настройки для сервера. Существует несколько профилей, как описано в [профили приложений](#application-profiles) раздел.

```json
"IdentityServer": {
  "Clients": {
    "angularindividualpreview3final": {
      "Profile": "IdentityServerSPA"
    }
  }
}
```

### <a name="appsettingsdevelopmentjson"></a>appSettings. Development.JSON

В *appsettings. Development.JSON* файл из корневой папки проекта есть `IdentityServer` раздел, описывающий ключ, используемый для подписи маркеров. При развертывании в рабочей среде, ключ необходимо подготовить и развернуть вместе с приложениями, как описано в [развертывание в рабочей среде](#deploy-to-production) раздел.

```json
"IdentityServer": {
  "Key": {
    "Type": "Development"
  }
}
```

## <a name="general-description-of-the-angular-app"></a>Общее описание приложения Angular

Аутентификацию и авторизацию API поддерживает в Angular шаблон находится в свой собственный модуль Angular в *ClientApp\src\api авторизации* каталога. Модуль состоит из следующих элементов:

* 3 компонента:
  * *Login.Component.TS*: Обрабатывает поток входа приложения.
  * *Logout.Component.TS*: Обрабатывает поток выхода приложения.
  * *login-menu.component.ts*: Мини-приложение, отображает одно из следующих ссылок:
    * Управление профилями пользователей и выход связи, когда пользователь проходит проверку подлинности.
    * Регистрация и вход связи, когда пользователь не прошел проверку подлинности.
* Условие маршрута `AuthorizeGuard` , можно добавить маршруты и пользователь должен пройти проверку подлинности перед посещением маршрута.
* Перехватчик HTTP `AuthorizeInterceptor` маркер доступа, присоединяет к исходящим запросам HTTP, предназначенных для API, когда пользователь проходит проверку подлинности.
* Услуга `AuthorizeService` , обрабатывает сведения низкого уровня процесса проверки подлинности и предоставляет информацию об аутентифицированном пользователе к остальной части приложения для использования.
* Angular модуль, который определяет маршруты, связанные с частями проверки подлинности приложения. Он предоставляет компонент меню для имени входа, перехватчик, условие и службы для потребления от остальной части приложения.

## <a name="general-description-of-the-react-app"></a>Общее описание приложение React

Поддержка проверки подлинности и авторизации API в шаблоне React находится в *ClientApp\src\components\api авторизации* каталога. Он состоит из следующих элементов:

* 4 компонентами:
  * *Login.js*: Обрабатывает поток входа приложения.
  * *Logout.js*: Обрабатывает поток выхода приложения.
  * *LoginMenu.js*: Мини-приложение, отображает одно из следующих ссылок:
    * Управление профилями пользователей и выход связи, когда пользователь проходит проверку подлинности.
    * Регистрация и вход связи, когда пользователь не прошел проверку подлинности.
  * *AuthorizeRoute.js*: Указанный компонент маршрута, который пользователь должен пройти проверку подлинности перед отображением компонента в `Component` параметра.
* Экспортированное `authService` экземпляр класса `AuthorizeService` , обрабатывает сведения низкого уровня процесса проверки подлинности и предоставляет информацию об аутентифицированном пользователе к остальной части приложения для использования.

Теперь, когда вы узнали основные компоненты решения, может занять более глубокое рассмотрение отдельные сценарии для приложения.

## <a name="require-authorization-on-a-new-api"></a>Требовать авторизации на новый интерфейс API

По умолчанию система настроена для легко требуют наличия авторизации для новых интерфейсов API. Чтобы сделать это, создайте новый контроллер и добавьте `[Authorize]` атрибут в класс контроллера или к любому действию контроллера.

## <a name="protect-a-client-side-route-angular"></a>Защитить клиентские маршрут (Angular)

Защита маршрут на стороне клиента можно сделать, добавив guard авторизовать в список условий, который будет выполняться при настройке маршрута. Например, можно увидеть как `fetch-data` маршрут настроен в модуле Angular основного приложения:

```typescript
RouterModule.forRoot([
  // ...
  { path: 'fetch-data', component: FetchDataComponent, canActivate: [AuthorizeGuard] },
])
```

Важно отметить, что защита маршрут не защищает фактической конечной точки (по-прежнему требуется `[Authorize]` атрибут, примененный к нему), но, что он только ограничивает пользователя перейти на заданный маршрут со стороны клиента, когда он не прошел проверку подлинности.

## <a name="authenticate-api-requests-angular"></a>Проверка подлинности запросов API (Angular)

Проверка подлинности запросов к API, размещенного вместе с приложениями выполняется автоматически при помощи перехватчик клиента HTTP, определенная приложением.

## <a name="protect-a-client-side-route-react"></a>Защитить клиентские маршрут (React)

Защитить клиентские маршрут с помощью `AuthorizeRoute` компонента вместо обычного `Route` компонента. Например, обратите внимание, как `fetch-data` маршрут настроен в `App` компонента:

```jsx
<AuthorizeRoute path='/fetch-data' component={FetchData} />
```

Защита маршрут:

* Не защищает фактической конечной точки (по-прежнему требуется `[Authorize]` атрибут, примененный к нему).
* Только пользователю перейти на заданный маршрут со стороны клиента, когда он не прошел проверку подлинности.

## <a name="authenticate-api-requests-react"></a>Проверка подлинности запросов API (React)

Проверка подлинности запросов с помощью React выполняется путем импорта `authService` экземпляра из `AuthorizeService`. Извлечение маркера доступа из `authService` и присоединенного к запросу, как показано ниже. В компонентах React, эта работа обычно выполняется `componentDidMount` метод жизненного цикла, так и в результате взаимодействия пользователей.

### <a name="import-the-authservice-into-your-component"></a>Импортировать authService в компоненте

```javascript
import authService from './api-authorization/AuthorizeService'
```

### <a name="retrieve-and-attach-the-access-token-to-the-response"></a>Получить и присоединить маркер доступа в ответ

```javascript
async populateWeatherData() {
  const token = await authService.getAccessToken();
  const response = await fetch('api/SampleData/WeatherForecasts', {
    headers: !token ? {} : { 'Authorization': `Bearer ${token}` }
  });
  const data = await response.json();
  this.setState({ forecasts: data, loading: false });
}
```

## <a name="deploy-to-production"></a>Развертывание в рабочей среде

Чтобы развернуть приложение в рабочей среде, необходимо подготовить следующие ресурсы:

* База данных для хранения идентификаторов учетных записей пользователей и предоставление разрешений IdentityServer.
* Рабочий сертификат для подписи маркеров.
  * Требования к этому сертификату; Это может быть, самозаверяющий сертификат или сертификат, предоставленными через Центр сертификации.
  * Его можно формировать с помощью стандартных средств, таких как PowerShell или OpenSSL.
  * Его можно устанавливать в хранилище сертификатов на целевых компьютерах или развернуть в качестве *.pfx* файл с надежным паролем.

### <a name="example-deploy-to-azure-websites"></a>Пример Развертывание на веб-сайты Azure

В этом разделе описывается развертывание приложения для веб-сайты Azure с помощью сертификата, хранящегося в хранилище сертификатов. Чтобы изменить приложение, чтобы загрузить сертификат из хранилища сертификатов, план службы приложений нужно размещать на по крайней мере уровень "стандартный", при настройке на более позднем этапе. В приложении *appsettings.json* файл, измените `IdentityServer` раздел, посвященный приведены основные сведения:

```json
"IdentityServer": {
  "Key": {
    "Type": "Store",
    "StoreName": "My",
    "StoreLocation": "CurrentUser",
    "Name": "CN=MyApplication"
  }
}
```

* Свойство name на сертификат соответствует различающееся субъекта для сертификата.
* Расположение хранилища представляет расположение для загрузки сертификата из (`CurrentUser` или `LocalMachine`).
* Имя хранилища представляет имя хранилища сертификатов, где хранится сертификат. В этом случае она указывает на хранилище пользователя.

Чтобы развернуть веб-сайтах Azure, развернуть приложение, описанные в [развертывание приложения в Azure](xref:tutorials/publish-to-azure-webapp-using-vs#deploy-the-app-to-azure) создать необходимые ресурсы Azure и развернуть приложение в рабочей среде.

После выполнения приведенных выше инструкций, приложение развертывается в Azure, но еще не функциональной. Сертификат, используемый приложением по-прежнему необходимо настроить. Найти отпечаток сертификата для использования и выполните действия, описанные в [загрузка сертификатов](/azure/app-service/app-service-web-ssl-cert-load#load-the-certificate-in-code).

Хотя эти шаги упомянуть SSL, то **закрытые сертификаты** раздела на портале, где можно загрузить подготовленную сертификат для использования с приложением.

После выполнения этого шага, перезапустите приложение и должно работать.

## <a name="other-configuration-options"></a>Другие параметры конфигурации

Поддержка API авторизации подключает IdentityServer с набором соглашений, значения по умолчанию и усовершенствования для упрощения работы для одностраничных приложений. Нечего и говорить всю мощь IdentityServer доступна за кулисами, если интеграции ASP.NET Core не занимают вашего сценария. Поддержка ASP.NET Core ориентирован на «» приложениях, где все приложения создаваемых и развертываемых решением нашей организации. Таким образом поддержка не предоставляется для таких вещей, как разрешение или федерации. Для этих сценариев используйте IdentityServer и следуйте его документации.

### <a name="application-profiles"></a>Профили приложений

Профили приложений являются стандартных конфигураций для приложений, уточнить свои параметры. В настоящее время поддерживаются следующие профили:

* `IdentityServerSPA`: Представляет одностраничного приложения, размещенного вместе с IdentityServer как единое целое.
  * `redirect_uri` По умолчанию используется `/authentication/login-callback`.
  * `post_logout_redirect_uri` По умолчанию используется `/authentication/logout-callback`.
  * Включает в себя набор областей `openid`, `profile`и всех областях, определенных для интерфейсов API в приложение.
  * Набор разрешенных типов ответов OIDC, `id_token token` или каждого из них по отдельности (`id_token`, `token`).
  * Режим допустимый ответ — `fragment`.
* `SPA`: Представляет SPA, которая не размещена с identityserver должно.
  * Включает в себя набор областей `openid`, `profile`и всех областях, определенных для интерфейсов API в приложение.
  * Набор разрешенных типов ответов OIDC, `id_token token` или каждого из них по отдельности (`id_token`, `token`).
  * Режим допустимый ответ — `fragment`.
* `IdentityServerJwt`: Представляет API, размещенного вместе с с IdentityServer.
  * Приложение настроено для одной области, по умолчанию используется имя приложения.
* `API`: Представляет интерфейс API, которая не размещена с identityserver должно.
  * Приложение настроено для одной области, по умолчанию используется имя приложения.

### <a name="configuration-through-appsettings"></a>Настройка с помощью AppSettings

Настройка приложений с помощью системы конфигурации, добавив их в список `Clients` или `Resources`.

Настройка каждого клиента `redirect_uri` и `post_logout_redirect_uri` свойства, как показано в следующем примере:

```json
"IdentityServer": {
  "Clients": {
    "MySPA": {
      "Profile": "SPA",
      "RedirectUri": "https://www.example.com/authentication/login-callback",
      "LogoutUri": "https://www.example.com/authentication/logout-callback"
    }
  }
}
```

При настройке ресурсов, можно настроить области для ресурса, как показано ниже:

```json
"IdentityServer": {
  "Resources": {
    "MyExternalApi": {
      "Profile": "API",
      "Scopes": "a b c"
    }
  }
}
```

### <a name="configuration-through-code"></a>Настройка с помощью кода

Можно также настроить клиентов и ресурсов с помощью кода, используя перегрузку `AddApiAuthorization` , выполняет действие для настройки параметров.

```csharp
AddApiAuthorization<ApplicationUser, ApplicationDbContext>(options =>
{
    options.Clients.AddSPA(
        "My SPA", spa =>
        spa.WithRedirectUri("http://www.example.com/authentication/login-callback")
           .WithLogoutRedirectUri(
               "http://www.example.com/authentication/logout-callback"));

    options.ApiResources.AddApiResource("MyExternalApi", resource =>
        resource.WithScopes("a", "b", "c"));
});
```

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:spa/angular>
* <xref:spa/react>
