---
title: ASP.NET Core моделей размещения Блазор
author: guardrex
description: Общие сведения о моделях размещения Блазор и Блазор Server.
monikerRange: '>= aspnetcore-3.0'
ms.author: riande
ms.custom: mvc
ms.date: 10/03/2019
uid: blazor/hosting-models
ms.openlocfilehash: bc3ad9c7c4731b685fc161844d9f55e51722c0ea
ms.sourcegitcommit: 73e255e846e414821b8cc20ffa3aec946735cd4e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/03/2019
ms.locfileid: "71924674"
---
# <a name="aspnet-core-blazor-hosting-models"></a>ASP.NET Core моделей размещения Блазор

По [Даниэль Roth)](https://github.com/danroth27)

[!INCLUDE[](~/includes/blazorwasm-preview-notice.md)]

Блазор — это веб-платформа, предназначенная для запуска на стороне клиента в браузере в среде выполнения .NET на основе [сборки](https://webassembly.org/)(*блазор*) или на стороне сервера в ASP.NET Core (*блазор Server*). Независимо от модели размещения, модели приложения и компонента *одинаковы*.

Сведения о создании проекта для моделей размещения, описанных в этой статье, <xref:blazor/get-started>см. в разделе.

## <a name="blazor-webassembly"></a>Blazor WebAssembly

Основная модель размещения для Блазор работает на стороне клиента в браузере на веб-сборке. Приложение Blazor, его зависимости и среда выполнения .NET скачиваются в браузере. Приложение выполняется непосредственно в потоке пользовательского интерфейса браузера. Обновления пользовательского интерфейса и обработка событий выполняются в рамках одного процесса. Ресурсы приложения развертываются как статические файлы на веб-сервере или в службе, способной обслуживать статические содержимое клиентам.

![Блазор: Приложение Блазор выполняется в потоке пользовательского интерфейса в браузере.](hosting-models/_static/blazor-webassembly.png)

Чтобы создать приложение Блазор с помощью клиентской модели размещения, используйте шаблон **приложения блазор для сборки** ([DotNet New блазорвасм](/dotnet/core/tools/dotnet-new)).

Выбрав шаблон **приложения блазор-Assembly** , вы можете настроить приложение для использования ASP.NET Core серверной части, установив флажок **ASP.NET Core размещения** ([DotNet New блазорвасм — Hosted](/dotnet/core/tools/dotnet-new)). ASP.NET Core приложение обслуживает приложения Блазор для клиентов. Приложение Блазор сборки может взаимодействовать с сервером по сети с помощью вызовов веб-API или [SignalR](xref:signalr/introduction).

Шаблоны включают скрипт *блазор... js* , который обрабатывает:

* Загрузка среды выполнения .NET, приложения и зависимостей приложения.
* Инициализация среды выполнения для запуска приложения.

Модель размещения Блазор содержит несколько преимуществ.

* Зависимость на стороне сервера .NET отсутствует. Приложение полностью работает после загрузки на клиент.
* Ресурсы и возможности клиента полностью используются.
* Работа разгружается с сервера на клиент.
* Веб-сервер ASP.NET Core не требуется для размещения приложения. Возможны сценарии бессерверного развертывания (например, обслуживание приложения из CDN).

Существует недостаток для Блазор размещения сборки.

* Приложение ограничено возможностями браузера.
* Требуется аппаратное и программное обеспечение, поддерживающее клиент (например, поддержка сборок).
* Размер скачивания больше, и приложения загружаются дольше.
* Поддержка среды выполнения .NET и инструментария менее зрела. Например, существуют ограничения на поддержку и отладку [.NET Standard](/dotnet/standard/net-standard) .

## <a name="blazor-server"></a>Blazor Server

При использовании модели размещения сервера Блазор приложение выполняется на сервере в приложении ASP.NET Core. Обновление элементов пользовательского интерфейса, обработка событий и вызовы JavaScript обрабатываются через подключение [SignalR](xref:signalr/introduction).

![Браузер взаимодействует с приложением (размещенным в приложении ASP.NET Core) на сервере через подключение SignalR.](hosting-models/_static/blazor-server.png)

Чтобы создать приложение Блазор с помощью модели размещения сервера Блазор, используйте шаблон **серверное приложение ASP.NET Core блазор** ([DotNet New блазорсервер](/dotnet/core/tools/dotnet-new)). В ASP.NET Core приложении размещается серверное приложение Блазор и создается конечная точка SignalR, в которую подключаются клиенты.

ASP.NET Core приложение ссылается на `Startup` класс приложения для добавления:

* Службы на стороне сервера.
* Приложение в конвейер обработки запросов.

Сценарий&dagger; *блазор. Server. js* устанавливает клиентское соединение. Ответственность за сохранение и восстановление состояния приложения в случае необходимости (например, в случае потери сетевого подключения) несет приложение.

Модель размещения сервера Блазор предлагает несколько преимуществ.

* Размер загружаемого файла значительно меньше, чем Блазор приложение сборки, и приложение загружается гораздо быстрее.
* Приложение обладает всеми преимуществами серверных возможностей, включая использование любых API-интерфейсов, совместимых с .NET Core.
* .NET Core на сервере используется для запуска приложения, поэтому существующие инструменты .NET, такие как отладка, работают должным образом.
* Поддерживаются тонкие клиенты. Например, серверные приложения Блазор работают с браузерами, которые не поддерживают сборку и устройства с ограниченными ресурсами.
* База .NET (C# код) приложения, включая код компонента приложения, не обслуживаются для клиентов.

Существуют недостатки для размещения сервера Блазор:

* Обычно существует большая задержка. Каждое взаимодействие с пользователем включает сетевой прыжок.
* Автономная поддержка отсутствует. Если подключение клиента завершается сбоем, приложение перестает работать.
* Масштабируемость — это сложная задача для приложений с большим количеством пользователей. Сервер должен управлять несколькими клиентскими подключениями и обрабатывать состояние клиента.
* Для обслуживания приложения требуется сервер ASP.NET Core. Сценарии бессерверного развертывания невозможны (например, обслуживание приложения из CDN).

&dagger;Сценарий *блазор. Server. js* обрабатывается из внедренного ресурса в ASP.NET Core общей платформе.

### <a name="comparison-to-server-rendered-ui"></a>Сравнение с ИНТЕРФЕЙСом, отображаемым сервером

Одним из способов понимания серверных приложений Блазор является понимание того, как оно отличается от традиционных моделей для отрисовки пользовательского интерфейса в ASP.NET Core приложениях с помощью представлений Razor или Razor Pages. В обеих моделях используется язык Razor для описания содержимого HTML, но они значительно отличаются от отрисовки разметки.

При отрисовке страницы Razor или представления каждая строка кода Razor выдает HTML в виде текста. После отрисовки сервер удаляет экземпляр страницы или представления, включая любое созданное состояние. Когда происходит другой запрос к странице, например при сбое проверки сервера и отображении сводки проверки:

* Вся страница снова преобразуется в HTML-текст.
* Страница отправляется клиенту.

Приложение Блазор состоит из многократно используемых элементов пользовательского интерфейса, называемых *компонентами*. Компонент содержит C# код, разметку и другие компоненты. При подготовке компонента к просмотру Блазор создает граф включенных компонентов, аналогичный HTML-или XML-модель DOM (DOM). Эта диаграмма включает в себя состояние компонента, содержащееся в свойствах и полях. Блазор оценивает граф компонентов для создания двоичного представления разметки. Двоичный формат может быть следующим:

* Преобразуется в текст HTML (во время предварительной отрисовки).
* Используется для эффективного обновления разметки во время обычной отрисовки.

Обновление пользовательского интерфейса в Блазор активируется следующим образом:

* Взаимодействие с пользователем, например выбор кнопки.
* Триггеры приложений, например таймер.

Граф перерисовывается, и вычисляется *различие в пользовательском* интерфейсе (разница). Это различие является наименьшим набором изменений DOM, необходимых для обновления пользовательского интерфейса на клиенте. Diff отправляется клиенту в двоичном формате и применяется в браузере.

Компонент уничтожается после того, как пользователь выходит из него с клиента. Несмотря на то, что пользователь взаимодействует с компонентом, состояние компонента (службы, ресурсы) должно храниться в памяти сервера. Так как состояние множества компонентов может поддерживаться сервером одновременно, нехватка памяти является проблемой, которую необходимо решить. Инструкции по созданию приложения Блазор Server для обеспечения оптимального использования памяти сервера см. в разделе <xref:security/blazor/server>.

### <a name="circuits"></a>Защит

Серверное приложение Блазор построено на основе [ASP.NET Core SignalR](xref:signalr/introduction). Каждый клиент обменивается данными с сервером по одному или нескольким подключениям SignalR, называемым *каналом*. Цепь — это Блазор абстракции соединений SignalR, которые могут допускать временные перерывы в сети. Когда клиент Блазор видит, что подключение SignalR разорвано, оно пытается повторно подключиться к серверу с помощью нового подключения SignalR.

Каждый экран браузера (вкладка браузера или IFRAME), подключенный к серверному приложению Блазор, использует подключение SignalR. Это еще одно важное различие по сравнению с обычными серверно-визуализированными приложениями. В приложении, готовом для просмотра, открытие одного и того же приложения на нескольких экранах браузера обычно не приводит к дополнительным требованиям к ресурсам на сервере. В серверном приложении Блазор каждый экран браузера требует отдельного канала и отдельных экземпляров состояния компонента для управления сервером.

Блазор рассматривает закрытие вкладки браузера или переход по внешнему URL-адресу *корректное* завершение. В случае корректного завершения работы канал и связанные ресурсы немедленно освобождаются. Клиент может также отключиться от некорректного, например, из-за прерывания работы сети. Блазор Server сохраняет отключенные цепи в течение настраиваемого интервала, чтобы разрешить клиенту повторное подключение. Дополнительные сведения см. в разделе повторное [Подключение к тому же серверу](#reconnection-to-the-same-server) .

### <a name="ui-latency"></a>Задержка пользовательского интерфейса

Задержка пользовательского интерфейса — это время, которое занимает от инициированного действия до момента обновления пользовательского интерфейса. Меньшее значение задержки пользовательского интерфейса является обязательным, чтобы приложение было легко реагировать на пользователя. В серверном приложении Блазор каждое действие отправляется на сервер, обрабатывается, и разница пользовательского интерфейса отправляется обратно. Следовательно, задержка пользовательского интерфейса — это сумма задержки в сети и задержки сервера при обработке действия.

Для бизнес-приложения, которое ограничено частной корпоративной сетью, воздействие на восприятие пользователей задержки из-за задержки в сети обычно незаметно. Для приложения, развернутого через Интернет, задержка может стать заметным для пользователей, особенно в том случае, если пользователи широко распределены географически.

Использование памяти может также повлиять на задержку приложения. Увеличение использования памяти приводит к частым сборкам мусора или выделению памяти на диск, что снижает производительность приложений и, следовательно, увеличивает задержку пользовательского интерфейса. Дополнительные сведения см. в разделе <xref:security/blazor/server>.

Блазор серверные приложения должны быть оптимизированы для минимизации задержки пользовательского интерфейса путем уменьшения задержки сети и использования памяти. Способ измерения задержки в сети см. в разделе <xref:host-and-deploy/blazor/server#measure-network-latency>. Дополнительные сведения о SignalR и Блазор см. в следующих статьях:

* <xref:host-and-deploy/blazor/server>
* <xref:security/blazor/server>

### <a name="reconnection-to-the-same-server"></a>Повторное подключение к тому же серверу

Для серверных приложений блазор требуется активное подключение SignalR к серверу. Если соединение потеряно, приложение попытается повторно подключиться к серверу. Пока состояние клиента по-прежнему находится в памяти, сеанс клиента возобновляется без потери состояния.

Когда клиент обнаруживает, что соединение потеряно, пользователь по умолчанию отображает пользовательский интерфейс, когда клиент пытается повторно подключиться. Если происходит сбой повторного подключения, пользователь предоставляет возможность повторить попытку. Чтобы настроить пользовательский интерфейс, определите элемент с `components-reconnect-modal` в качестве `id` на странице Razor *_Host. cshtml* . Клиент обновляет этот элемент одним из следующих классов CSS в зависимости от состояния соединения:

* `components-reconnect-show` &ndash; показывает, что пользовательский интерфейс указывает на потерянное подключение, а клиент пытается повторно подключиться.
* `components-reconnect-hide`&ndash; Клиент имеет активное соединение, скрыть пользовательский интерфейс.
* `components-reconnect-failed` &ndash; не удалось выполнить повторное подключение, возможно, из-за сбоя сети. Чтобы повторить попытку подключения, вызовите `window.Blazor.reconnect()`.
* `components-reconnect-rejected` &ndash; повторное подключение отклонено. Сервер был достигнут, но отклонил подключение, и состояние пользователя на сервере отсутствует. Чтобы перезагрузить приложение, вызовите `location.reload()`. Это состояние соединения может появиться в следующих случаях:
  * Сбой в цепи (код на стороне сервера).
  * Клиент отключается достаточно долго, чтобы сервер отключил состояние пользователя. Удаляются экземпляры компонентов, с которыми взаимодействовал пользователь.

### <a name="stateful-reconnection-after-prerendering"></a>Повторное подключение с отслеживанием состояния после предварительной подготовки к просмотру

Серверные приложения блазор по умолчанию настроены на выстройку пользовательского интерфейса на сервере, прежде чем будет установлено клиентское соединение с сервером. Это настраивается на странице Razor *_Host. cshtml* :

```cshtml
<body>
    <app>@(await Html.RenderComponentAsync<App>(RenderMode.ServerPrerendered))</app>

    <script src="_framework/blazor.server.js"></script>
</body>
```

`RenderMode`Настраивает, является ли компонент:

* Предварительно отображается на странице.
* Отображается как статический HTML на странице или включает необходимые сведения для начальной загрузки приложения Блазор из агента пользователя.

| `RenderMode`        | Описание |
| ------------------- | ----------- |
| `ServerPrerendered` | Преобразует компонент в статический HTML и включает маркер для серверного приложения Блазор. При запуске агента пользователя этот маркер используется для начальной загрузки приложения Блазор. Параметры не поддерживаются. |
| `Server`            | Отображает маркер для серверного приложения Блазор. Выходные данные компонента не включаются. При запуске агента пользователя этот маркер используется для начальной загрузки приложения Блазор. Параметры не поддерживаются. |
| `Static`            | Преобразует компонент в статический HTML. Поддерживаются параметры. |

Отрисовка компонентов сервера из статической HTML-страницы не поддерживается.

Клиент повторно подключится к серверу с тем же состоянием, которое использовалось для выprerender приложения. Если состояние приложения по-прежнему находится в памяти, состояние компонента не будет повторно отображено после установления подключения SignalR.

### <a name="render-stateful-interactive-components-from-razor-pages-and-views"></a>Отображение интерактивных компонентов с отслеживанием состояния из страниц и представлений Razor

Интерактивные компоненты с отслеживанием состояния могут быть добавлены на страницу Razor или в представление.

При визуализации страницы или представления:

* Компонент предварительно отображается страницей или представлением.
* Исходное состояние компонента, используемое для предварительной визуализации, потеряно.
* Состояние нового компонента создается при установлении подключения SignalR.

Следующая страница Razor визуализирует `Counter` компонент:

```cshtml
<h1>My Razor Page</h1>

@(await Html.RenderComponentAsync<Counter>(RenderMode.ServerPrerendered))
```

### <a name="render-noninteractive-components-from-razor-pages-and-views"></a>Прорисовка неинтерактивных компонентов на страницах и представлениях Razor

На следующей странице `MyComponent` Razor компонент статически подготавливается к просмотру с начальным значением, указанным с помощью формы:

```cshtml
<h1>My Razor Page</h1>

<form>
    <input type="number" asp-for="InitialValue" />
    <button type="submit">Set initial value</button>
</form>

@(await Html.RenderComponentAsync<MyComponent>(RenderMode.Static, 
    new { InitialValue = InitialValue }))

@code {
    [BindProperty(SupportsGet=true)]
    public int InitialValue { get; set; }
}
```

Так `MyComponent` как статически отображается, компонент не может быть интерактивным.

### <a name="detect-when-the-app-is-prerendering"></a>Обнаруживать время подготовки приложения к просмотру

[!INCLUDE[](~/includes/blazor-prerendering.md)]

### <a name="configure-the-signalr-client-for-blazor-server-apps"></a>Настройка клиента SignalR для серверных приложений Блазор

Иногда необходимо настроить клиент SignalR, используемый серверными приложениями Блазор. Например, может потребоваться настроить ведение журнала на клиенте SignalR для диагностики проблемы с подключением.

Чтобы настроить клиент SignalR в файле *pages/_Host. cshtml* , сделайте следующее:

* Добавьте атрибут в тег для скрипта *блазор. Server. js.* `<script>` `autostart="false"`
* Вызовите `Blazor.start` и передайте объект конфигурации, указывающий построитель SignalR.

```html
<script src="_framework/blazor.server.js" autostart="false"></script>
<script>
  Blazor.start({
    configureSignalR: function (builder) {
      builder.configureLogging(2); // LogLevel.Information
    }
  });
</script>
```

## <a name="additional-resources"></a>Дополнительные ресурсы

* <xref:blazor/get-started>
* <xref:signalr/introduction>
